<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HPS-MC: hps-mc installation guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HPS-MC
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('readme.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">hps-mc installation guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a></p>
<h2><a class="anchor" id="autotoc_md54"></a>
Prerequisites</h2>
<p>There are a number of required programs and tools you must have installed on your system to build and run hps-mc.</p>
<ul>
<li>wget</li>
<li>git</li>
<li>gcc &gt;= 4.8</li>
<li>CMake &gt;= 3.18</li>
<li>Maven &gt;= 3.0</li>
<li>python &gt;= 3.6</li>
<li>Java =1.8</li>
<li>GSL =<a href="https://ftp.gnu.org/gnu/gsl/gsl-1.16.tar.gz">1.16</a></li>
</ul>
<p>Most of these dependencies can be installed on Ubuntu using:</p>
<div class="fragment"><div class="line">sudo apt-get install build-essential maven gfortran cmake python3 libgsl-dev git wget</div>
</div><!-- fragment --><p>You may want to <a href="https://cmake.org/download/">download</a> and install the latest version of CMake instead of using the one from your package manager so that it is up to date.</p>
<p>A few Python libraries need to be installed as well:</p>
<div class="fragment"><div class="line">pip install psutil jinja2</div>
</div><!-- fragment --><p>The <a href="https://github.com/slaclab/slic">slic</a> program should be pre-installed and available in the system path.</p>
<p>Some scripts may also require that the <a href="https://github.com/JeffersonLab/hps-dst">DST Maker</a> is installed and available in the system path.</p>
<h2><a class="anchor" id="autotoc_md55"></a>
Installation</h2>
<p>You need to have CMake installed on your system as well as gcc (preferably version 4.8 or greater).</p>
<p>To build the project:</p>
<div class="fragment"><div class="line">cd hps-mc; mkdir build; cd build</div>
<div class="line">cmake -DCMAKE_INSTALL_PREFIX=../install -DGSL_ROOT_DIR=$GSL_ROOT_DIR ..</div>
<div class="line">make install</div>
</div><!-- fragment --><p>The <code>GSL_ROOT_DIR</code> variable should be set to the GSL installation prefix which was used when you configured it (directory should contain the directories bin, include, etc.).</p>
<p>To build with additional external dependencies installed automatically:</p>
<div class="fragment"><div class="line">cmake -DCMAKE_INSTALL_PREFIX=$(realpath ../install) -DGSL_ROOT_DIR=/work/slac/sw/gsl/gsl-1.16-install/ -DENABLE_INSTALL_GENERATORS=ON -DENABLE_INSTALL_FIELDMAPS=ON -DENABLE_INSTALL_LCIO=ON -DENABLE_INSTALL_HPSJAVA=ON -DENABLE_INSTALL_CONDITIONS=ON ..</div>
</div><!-- fragment --><p>This should install all of the tools to <code>hps-mc/install</code>. <br  />
</p>
<p>Change <code>CMAKE_INSTALL_PREFIX</code> above if you wish to install to a different directory.</p>
<h2><a class="anchor" id="autotoc_md56"></a>
Environment Setup</h2>
<p>Before running scripts, the environment script should be sourced.</p>
<p>This sources the bash environment setup script:</p>
<div class="fragment"><div class="line">. hps-mc/install/bin/hps-mc-env.sh</div>
</div><!-- fragment --><p>This is the corresponding command for c-shell:</p>
<div class="fragment"><div class="line">. hps-mc/install/bin/hps-mc-env.csh</div>
</div><!-- fragment --><p>The SLIC executable and DST Maker are "sold separately" so these commands should be setup in your environment.</p>
<p>You can check if they are available using:</p>
<div class="fragment"><div class="line">which slic</div>
<div class="line">which dst_maker</div>
</div><!-- fragment --><p>You should also check that typing <code>slic</code> and <code>dst_maker</code> executes these commands correctly.</p>
<h2><a class="anchor" id="autotoc_md57"></a>
Running Job Scripts</h2>
<p>You will want to run jobs from a scratch directory as many of components create a lot of files:</p>
<div class="fragment"><div class="line">mkdir /scratch/myjob</div>
<div class="line">cd /scratch/myjob</div>
</div><!-- fragment --><p>Now you can execute one of the test jobs:</p>
<div class="fragment"><div class="line">python hps-mc/python/test/egs5_test.py</div>
</div><!-- fragment --><p>In the above command insert the full path to your hps-mc installation instead of <code>hps-mc</code> or you can copy the python script to the scratch directory.</p>
<h2><a class="anchor" id="autotoc_md58"></a>
Documentation</h2>
<p>The source code documentation can be found <a href="https://jeffersonlab.github.io/hps-mc/">here</a>. For additional information of how to use the job scripts, refer to the examples directory and the comments in there.</p>
<h2><a class="anchor" id="autotoc_md59"></a>
Quick Start Guide</h2>
<p>The first step to setting up an system to run jobs via hps-mc is first producing <code>~/.hpsmc</code> which will set all of the system level configuration parameters for all types of jobs. An example of what a system level .hpsmc file should look like is provided at <code>config/bravo_sdf.cfg</code>. One can simply copy this to <code>~/.hpsmc</code> of the system and update the paths to point to the relevant locations on that particular system.</p>
<p>The system level configuration file should not be confused with a job level configuration file, typcially kept in the directory used to prepare and submit the jobs. hps-mc will go looking in a few standard locations for configuration files named <code>.hpsmc</code> and load any configurations in them. The local directory where the submission command is issued is the last place searched and parameters in this location will override all others, if any conflicts exist. An example of a job level configuration file is provided at <code>config/job.cfg</code> as well as more in the various example jobs provided in the examples directory.</p>
<p>The next step of the process is to build up a jobs.json file with all of the relevant job configurations. Looking in <code>examples/tritrig_gen</code> one can see a few different scripts as examples of how one can put together a jobs.json file to be used to submit/run jobs using the various available computing resources hps-mc knows how to leverage. Following the example of <code>examples/tritrig_gen</code> one can navigate to this directory and inspect <code>mkjobs.sh</code> to see the command for automatically generating a jobs.json configuration. The provided job.json configuration only defines a single job, and can not be used to submit jobs to a batch system and is used for local testing purposes. <code>hps-mc-job-template</code> takes in a few different types of arguements to tell it how you want to generate your jobs.</p>
<p>Parameters one might want to iterate over in jobs can be entered into lists in vars.json, the example uses this to generate the sample with two different target positions, just to illustrate this feature. Another important arguement for <code>hps-mc-job-template</code> is job.json.tmpl. This is the filename for the job template to be used to define all the parameters for one particular job. Variables provided in the vars.json file can be accessed in job.json.tmpl inside of double curly braces, and jinja2 support is available for processing the variables. An example of this feature is the seed parameter in <code>examples/tritrig_gen</code> where an offset is added to <code>job_id</code> (which is always an available template variable) to make a unique seed number for each job. Jinja2 is a well documented templating engine on which this part of hps-mc is based.</p>
<p>After one has generated a jobs.json file, the jobs it defines can be ran locally, in a pool, or submitted to one of the various batch systems it supports via <code>hps-mc-batch</code>. In <code>examples/tritrig_gen</code> there are a few examples of submission commands in <code>run_pool.sh</code>, <code>submit_lsf.sh</code>, and <code>run_slurm.sh</code>. Slurm in particular will generate script to use to submit each individual job. With some small modifications one can use these to prepare a job array to submit to slurm, if one wants to use that particular feature of the Slurm system. Ultimately, hps-mc just prepares a single run command using <code>hps-mc-job</code> which the batch tool knows how to prepare and call properly, given the configuration and parameters of each job, to get the job running in any of the supported run modes (local, pool, or some batch system).</p>
<p>It is recommended to slowly build up jobs and tests them locally first before submitting a whole set to a batch system to run. This can be with commands nearly identical to the commands used to submit the jobs to a batch system (local or pool). The system is pretty abstracted so you might even find a new clever way to leverage the features of hps-mc to speed up the process of defining job sets, or even just getting the jobs ran.</p>
<h2><a class="anchor" id="autotoc_md60"></a>
Code Formatting</h2>
<p>There is a github action ensuring proper formatting of python code in <code>hps-mc</code>. This action will fail if the pushed code does not follow the <b>PEP 8 style conventions</b>.</p>
<p>To prevent this action from failing, you can check if your code is formatted correctly locally before pushing. This can be done using <a href="https://pycodestyle.pycqa.org/en/latest/intro.html#configuration">pycodestyle</a>, by navigating to the top directory of hps-mc and running </p><div class="fragment"><div class="line">pycodestyle --ignore=E266,E501,E121,E123,E126,E133,E226,E241,E242,E704,W503,W504,W505 --max-line-length=160 python/</div>
</div><!-- fragment --><p> which will display all formatting errors in <code>python/</code>. Before running this, make sure pycodestyle is installed on your machine. If you need to install it, you can do this by running </p><div class="fragment"><div class="line">pip install --user pycodestyle</div>
</div><!-- fragment --><p>You can automate the style check by creating a git pre-commit hook. This will automatically check all python files upon running <code>git commit</code>. To add the pre-commit hook, navigate to the <code>.git/hooks/</code> directory in <code>hps-mc</code>, create a pre-commit hook, and make it executable. If you already have pre-commit hooks, you can skip this step. </p><div class="fragment"><div class="line">cd .git/hooks</div>
<div class="line">touch pre-commit</div>
<div class="line">chmod +x pre-commit</div>
</div><!-- fragment --><p> Then, add the following lines to <code>pre-commit</code> </p><div class="fragment"><div class="line">#!/bin/sh</div>
<div class="line">pycodestyle --ignore=E266,E501,E121,E123,E126,E133,E226,E241,E242,E704,W503,W504,W505 --max-line-length=160 python/</div>
</div><!-- fragment --><p>To fix the formatting errors, you can either do this manually by navigating to the displayed files and making the necessary changes, or you can use <a href="https://pypi.org/project/autopep8/#installation">autopep8</a> as follows. First, install autopep8: </p><div class="fragment"><div class="line">pip install --user --upgrade autopep8</div>
</div><!-- fragment --><p> Then run </p><div class="fragment"><div class="line">autopep8 --aggressive --aggressive --ignore=E265,E266,E501,E121,E123,E126,E133,E226,E241,E242,E704,W503,W504,W505 --in-place --max-line-length=160 --recursive python/</div>
</div><!-- fragment --><p> from the top of the <code>hps-mc</code> directory. Alternatively, run <code>format_python_code.sh</code>. This will automatically fix (most) of the formatting issues.</p>
<p>To preserve the Doxygen-style comments, it is necessary to disable the automatic formatting of comment blocks which means that you might need to fix those by hand.</p>
<h2><a class="anchor" id="autotoc_md61"></a>
Unit tests</h2>
<p>Unit tests for the hps-mc python modules can be found in <code>python/test</code>. There are several ways to run the tests. Assuming you are in <code>python/test</code>, you can</p><ul>
<li>run all tests at once: <div class="fragment"><div class="line">python3 -m unittest -v</div>
</div><!-- fragment --> The <code>-v</code> option creates a more verbose output than the standard output. If you're running the tests for the first time, you might need to run: <div class="fragment"><div class="line">python3 -m unittest discover -v</div>
</div><!-- fragment --></li>
<li>run a test module: <div class="fragment"><div class="line">python3 -m unittest -v test_some_module.py</div>
</div><!-- fragment --> or <div class="fragment"><div class="line">python3 -m unittest -v test_some_module</div>
</div><!-- fragment --></li>
<li>run a selection of test modules: <div class="fragment"><div class="line">python3 -m unittest -v test_some_module test_another_module</div>
</div><!-- fragment --></li>
<li>run a specific test class or test in a module: <div class="fragment"><div class="line">python3 -m unittest -v test_some_module.TestClass.test_method</div>
</div><!-- fragment --> More details on the python <code>unittest</code> framework can be found <a href="https://docs.python.org/3/library/unittest.html">here</a>.</li>
</ul>
<h2><a class="anchor" id="autotoc_md62"></a>
Help</h2>
<p>You can post any questions or report problems on the <a href="https://heavyphotonsearch.slack.com/">HPS Slack</a> in the <a href="https://heavyphotonsearch.slack.com/messages/C47LLBP5F">montecarlo</a> channel.</p>
<p>The HPS software mailing list can also be used for help. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
